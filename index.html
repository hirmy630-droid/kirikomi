<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>切込寸法 計算アプリ - Dark Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, getDocs, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state
        window.historyData = [];
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cutting-calc-app';
        let lastSavedHash = ""; 
        let autoSaveTimeout = null;
        
        const useLocalState = typeof __firebase_config === 'undefined';
        const LOCAL_STORAGE_KEY = 'cutting_calc_history_v1';

        const loadLocalHistory = () => {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (stored) {
                try {
                    window.historyData = JSON.parse(stored);
                } catch(e) {
                    window.historyData = [];
                }
            }
            window.renderHistory();
        };

        const saveLocalHistory = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(window.historyData));
        };

        const initFirebase = async () => {
            if (useLocalState) {
                loadLocalHistory();
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                await initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadHistory();
                    }
                });
            } catch (e) {
                console.error("Firebase初期化エラー:", e);
            }
        };

        const loadHistory = () => {
            if (useLocalState || !userId) return;
            const historyCol = collection(db, 'artifacts', appId, 'users', userId, 'history');
            
            onSnapshot(historyCol, async (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // チェック済みを優先し、その中で作成日時順に並び替え
                window.historyData = data.sort((a, b) => {
                    if (a.checked !== b.checked) return a.checked ? -1 : 1;
                    return b.createdAt - a.createdAt;
                });
                
                // チェックなしが3件を超えたら古いものを消す
                const uncheckedItems = window.historyData.filter(item => !item.checked);
                if (uncheckedItems.length > 3) {
                    const toDelete = uncheckedItems.slice(3); 
                    const batch = writeBatch(db);
                    toDelete.forEach(item => {
                        batch.delete(doc(db, 'artifacts', appId, 'users', userId, 'history', item.id));
                    });
                    await batch.commit();
                }
                window.renderHistory();
            }, (error) => {
                console.error("Firestore Loading Error:", error);
            });
        };

        window.saveToCloud = async (item) => {
            if (!item) return;
            
            // 内容が変わっていない場合は保存しない
            const hash = JSON.stringify(item.inputs) + item.mode + item.no + (item.calcDir || '');
            if (hash === lastSavedHash) return; 
            lastSavedHash = hash;

            const newItem = { ...item, checked: false, createdAt: Date.now() };

            if (useLocalState) {
                newItem.id = Date.now().toString();
                window.historyData.unshift(newItem);
                window.historyData.sort((a, b) => {
                    if (a.checked !== b.checked) return a.checked ? -1 : 1;
                    return b.createdAt - a.createdAt;
                });
                // ローカル状態でも3件制限を適用
                const uncheckedItems = window.historyData.filter(d => !d.checked);
                if (uncheckedItems.length > 3) {
                    const idsToDelete = uncheckedItems.slice(3).map(d => d.id);
                    window.historyData = window.historyData.filter(d => !idsToDelete.includes(d.id));
                }
                saveLocalHistory();
                window.renderHistory();
                return;
            }

            if (!userId) return;
            const historyCol = collection(db, 'artifacts', appId, 'users', userId, 'history');
            await addDoc(historyCol, newItem);
        };

        window.triggerAutoSave = (item) => {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                window.saveToCloud(item);
            }, 800); // 入力停止から800ms後に保存
        };

        window.toggleCheck = async (id, currentStatus) => {
            if (useLocalState) {
                const item = window.historyData.find(d => d.id === id);
                if (item) item.checked = !currentStatus;
                window.historyData.sort((a, b) => {
                    if (a.checked !== b.checked) return a.checked ? -1 : 1;
                    return b.createdAt - a.createdAt;
                });
                saveLocalHistory();
                window.renderHistory();
                return;
            }
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'history', id);
            await updateDoc(docRef, { checked: !currentStatus });
        };

        window.openConfirm = (action, mode = '') => {
            const modal = document.getElementById('customConfirmModal');
            const msg = document.getElementById('confirmMessage');
            window.pendingAction = { action, mode };
            msg.innerText = action === 'category' ? `${mode}切込の履歴を削除しますか？` : "全ての履歴を一括削除しますか？";
            modal.classList.remove('hidden');
        };

        window.executeConfirm = async () => {
            if (!window.pendingAction) return;
            const { action, mode } = window.pendingAction;
            if (useLocalState) {
                window.historyData = window.historyData.filter(d => {
                    if (d.checked) return true;
                    if (action === 'all') return false;
                    if (action === 'category' && d.mode === mode) return false;
                    return true;
                });
                document.getElementById('customConfirmModal').classList.add('hidden');
                saveLocalHistory();
                window.renderHistory();
                return;
            }
            if (!userId) return;
            let itemsToDelete = window.historyData.filter(d => !d.checked && (action === 'all' || d.mode === mode));
            if (itemsToDelete.length > 0) {
                const batch = writeBatch(db);
                itemsToDelete.forEach(d => batch.delete(doc(db, 'artifacts', appId, 'users', userId, 'history', d.id)));
                await batch.commit();
            }
            document.getElementById('customConfirmModal').classList.add('hidden');
        };

        window.onload = initFirebase;
    </script>

    <style>
        :root {
            --theme-color: #ff9f0a;
            --theme-btn-start: #ffb340;
            --theme-btn-end: #ff9f0a;
            --theme-btn-shadow: #cc7f08;
        }

        .app-container.mode-height {
            --theme-color: #e67600;
            --theme-btn-start: #ff8c00;
            --theme-btn-end: #e67600;
            --theme-btn-shadow: #994f00;
        }

        body { background-color: #000000; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; overflow-x: hidden; touch-action: pan-y; }
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s ease; }
        .input-card { background: #1c1c1e; border-radius: 14px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        
        .tab-bar { background-color: #111; padding: 4px; border-radius: 12px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.5); }
        .tab-button { 
            padding-top: 0.6rem; 
            padding-bottom: 0.6rem; 
            font-size: 16px !important; 
            color: #8e8e93; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            background: linear-gradient(180deg, #2c2c2e 0%, #1c1c1e 100%);
            border: 2px solid transparent;
            margin: 0 2px;
        }
        .tab-active { 
            background: linear-gradient(180deg, #48484a 0%, #2c2c2e 100%) !important; 
            color: var(--theme-color) !important; 
            border: 2px solid var(--theme-color) !important;
            font-weight: 900;
            transform: translateY(-1px);
        }

        input { background-color: #2c2c2e !important; color: #ffffff !important; border: 1px solid #3a3a3c !important; }
        .input-highlight-border { border: 2px solid var(--theme-color) !important; transition: border-color 0.3s ease; }
        input::placeholder { font-size: 16px; color: #636366; }

        .history-item { 
            animation: slideIn 0.3s ease-out; 
            background: #1c1c1e; 
            border: 1px solid #2c2c2e; 
            cursor: pointer;
            transition: all 0.1s ease;
        }
        .history-item:active { transform: scale(0.98); background: #2c2c2e; }
        .history-item.checked { border-color: var(--theme-color); }

        .dir-switch-bar { background-color: #1c1c1e; padding: 2px; border-radius: 8px; }
        .dir-button { font-size: 13px !important; color: #aeaeb2; padding: 6px 12px; transition: all 0.2s; border: 2px solid transparent; }
        .dir-active { 
            background-color: #3a3a3c !important; 
            color: var(--theme-color) !important; 
            border: 2px solid var(--theme-color) !important; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); 
        }

        .btn-gray-3d { background: linear-gradient(180deg, #aeaeb2 0%, #8e8e93 100%); color: #ffffff; border: 1px solid #aeaeb2; box-shadow: 0 3px 0 #3a3a3c; }
        .btn-silver-3d { background: linear-gradient(180deg, #f2f2f7 0%, #d1d1d6 100%); color: #1c1c1e; border: 1px solid #ffffff; box-shadow: 0 3px 0 #48484a; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-white">

<div class="app-container p-4" id="mainApp">
    <header class="text-center py-4">
        <h1 class="text-[32px] font-bold text-white tracking-tight">切込寸法 計算</h1>
        <p class="text-[15px] font-medium text-[#d1d1d6] mt-0 uppercase tracking-widest">KYOWA ROOF</p>
    </header>

    <div class="flex mb-6 tab-bar">
        <button type="button" onclick="switchTab('side')" id="tabSide" class="tab-button flex-1 font-bold rounded-[8px] tab-active">横 切込</button>
        <button type="button" onclick="switchTab('height')" id="tabHeight" class="tab-button flex-1 font-bold rounded-[8px]">縦 切込</button>
    </div>

    <div id="contentArea">
        <div id="sideContent">
            <div class="input-card p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 ml-1">働き幅 (＠)</label>
                        <input type="text" inputmode="numeric" id="side_a" placeholder="働き幅" oninput="formatInput(this); calculateSide();" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                    <div>
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 ml-1">横幅 (開口部)</label>
                        <input type="text" inputmode="numeric" id="side_l2" placeholder="横幅" oninput="formatInput(this); calculateSide();" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="w-20">
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 text-center">No.</label>
                        <input type="text" inputmode="numeric" id="side_no" maxlength="2" placeholder="No" oninput="calculateSide();" onfocus="this.select()" class="w-full rounded-xl px-2 py-3 text-[27px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 ml-1">寸法 (張方向↔︎対象)</label>
                        <input type="text" inputmode="numeric" id="side_l1" placeholder="寸法" oninput="formatInput(this); calculateSide();" onfocus="this.select()" class="w-full rounded-xl px-3 py-3 text-[28px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                </div>
            </div>
        </div>

        <div id="heightContent" class="hidden">
            <div class="input-card p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 ml-1">全長 (L)</label>
                        <input type="text" inputmode="numeric" id="h_total" placeholder="全長" oninput="formatInput(this); calculateHeight();" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                    <div>
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 ml-1">縦幅 (開口部)</label>
                        <input type="text" inputmode="numeric" id="h_l2" placeholder="縦幅" oninput="formatInput(this); calculateHeight();" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="w-20">
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 text-center">No.</label>
                        <input type="text" inputmode="numeric" id="h_no" maxlength="2" placeholder="No" oninput="calculateHeight();" onfocus="this.select()" class="w-full rounded-xl px-2 py-3 text-[27px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[14px] font-semibold text-[#d1d1d6] mb-1 ml-1">寸法 (下↑対象)</label>
                        <input type="text" inputmode="numeric" id="h_l1" placeholder="寸法" oninput="formatInput(this); calculateHeight();" onfocus="this.select()" class="w-full rounded-xl px-3 py-3 text-[28px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果表示エリア -->
    <div id="resultArea" class="hidden space-y-3 mb-10">
        <div id="directionToggle" class="flex justify-center mb-1">
            <div class="dir-switch-bar flex gap-1">
                <button type="button" onclick="setCalcDir('LtoR')" id="btnLtoR" class="dir-button font-bold dir-active">左←右</button>
                <button type="button" onclick="setCalcDir('RtoL')" id="btnRtoL" class="dir-button font-bold">左→右</button>
            </div>
        </div>
        <div class="bg-[#111] rounded-2xl border border-[#333] shadow-xl overflow-hidden p-1">
            <div id="svgContainer" class="w-full bg-[#000] rounded-xl overflow-hidden"></div>
        </div>
        <div id="numericResults" class="grid gap-3"></div>
    </div>

    <!-- 履歴エリア -->
    <div id="historyArea" class="mt-4 border-t border-[#2c2c2e] pt-6 pb-24">
        <div class="flex items-center justify-between mb-8 px-1">
            <h2 class="text-[22px] font-bold text-white tracking-tight">計算履歴 <span class="text-[12px] font-normal text-[#8e8e93] ml-2">(自動保存:最新3件)</span></h2>
            <button type="button" onclick="openConfirm('all')" class="btn-gray-3d text-[11px] font-black px-4 py-1.5 rounded-full uppercase shadow-sm">一括削除</button>
        </div>
        <div class="mb-12">
            <div class="flex justify-between items-center mb-5 px-1">
                <h3 class="text-[#d1d1d6] text-[18px] font-bold uppercase tracking-widest">横切込の履歴</h3>
                <button type="button" onclick="openConfirm('category', '横')" class="btn-silver-3d text-[10px] font-black px-4 py-1.5 rounded-full shadow-sm">削除</button>
            </div>
            <div id="sideHistoryList" class="space-y-4"></div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-5 px-1">
                <h3 class="text-[#d1d1d6] text-[18px] font-bold uppercase tracking-widest">縦切込の履歴</h3>
                <button type="button" onclick="openConfirm('category', '縦')" class="btn-silver-3d text-[10px] font-black px-4 py-1.5 rounded-full shadow-sm">削除</button>
            </div>
            <div id="heightHistoryList" class="space-y-4"></div>
        </div>
    </div>

    <!-- モーダル -->
    <div id="customConfirmModal" class="hidden fixed inset-0 flex items-center justify-center p-6 shadow-2xl" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 9999;">
        <div class="bg-[#1c1c1e] w-full max-w-sm rounded-3xl p-6 border border-[#3a3a3c] text-center shadow-2xl">
            <h4 class="text-[18px] font-bold text-white mb-3">確認</h4>
            <p id="confirmMessage" class="text-[#d1d1d6] text-[14px] mb-6 leading-relaxed"></p>
            <div class="flex gap-3">
                <button type="button" onclick="document.getElementById('customConfirmModal').classList.add('hidden')" class="flex-1 bg-[#2c2c2e] text-white font-bold py-3 rounded-xl active:opacity-70 transition-opacity">キャンセル</button>
                <button type="button" onclick="executeConfirm()" class="flex-1 bg-[#ff453a] text-white font-bold py-3 rounded-xl active:opacity-70 transition-opacity">削除する</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentMode = 'side', currentResult = null, calcDirection = 'LtoR';

    function switchTab(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        const container = document.getElementById('mainApp');
        if (mode === 'height') container.classList.add('mode-height'); else container.classList.remove('mode-height');
        document.getElementById('sideContent').classList.toggle('hidden', mode !== 'side');
        document.getElementById('heightContent').classList.toggle('hidden', mode !== 'height');
        document.getElementById('tabSide').classList.toggle('tab-active', mode === 'side');
        document.getElementById('tabHeight').classList.toggle('tab-active', mode === 'height');
        if (mode === 'side') calculateSide(); else calculateHeight();
        document.getElementById('directionToggle').classList.toggle('hidden', mode !== 'side');
    }

    let startX = 0;
    const mainApp = document.getElementById('mainApp');
    mainApp.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, {passive: true});
    mainApp.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX, diffX = endX - startX, threshold = 70;
        if (diffX > threshold) { if (currentMode !== 'side') switchTab('side'); }
        else if (diffX < -threshold) { if (currentMode !== 'height') switchTab('height'); }
    });

    function setCalcDir(dir) {
        calcDirection = dir;
        document.getElementById('btnLtoR').classList.toggle('dir-active', dir === 'LtoR');
        document.getElementById('btnRtoL').classList.toggle('dir-active', dir === 'RtoL');
        if (currentMode === 'side') calculateSide();
    }

    function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function unformatNumber(str) { return str ? str.replace(/,/g, '') : ''; }

    window.formatInput = function(el) {
        let val = unformatNumber(el.value);
        if (isNaN(val) && val !== "") { el.value = el.dataset.oldValue || ""; return; }
        el.value = (val === "") ? "" : formatNumber(val);
        el.dataset.oldValue = el.value;
    };

    window.applyHistoryItem = function(id) {
        const item = window.historyData.find(d => d.id === id);
        if (!item) return;
        if (item.mode === '横') {
            switchTab('side');
            if (item.calcDir) setCalcDir(item.calcDir);
            document.getElementById('side_a').value = formatNumber(item.inputs.a);
            document.getElementById('side_l2').value = formatNumber(item.inputs.l2);
            document.getElementById('side_l1').value = formatNumber(item.inputs.l1);
            document.getElementById('side_no').value = item.no;
            calculateSide();
        } else {
            switchTab('height');
            document.getElementById('h_total').value = formatNumber(item.inputs.total);
            document.getElementById('h_l2').value = formatNumber(item.inputs.l2);
            document.getElementById('h_l1').value = formatNumber(item.inputs.l1);
            document.getElementById('h_no').value = item.no;
            calculateHeight();
        }
        setTimeout(() => { const el = document.getElementById('resultArea'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
    };

    window.calculateSide = function() {
        const aVal = unformatNumber(document.getElementById('side_a').value), l2Val = unformatNumber(document.getElementById('side_l2').value), l1Val = unformatNumber(document.getElementById('side_l1').value), noVal = document.getElementById('side_no').value;
        const a = parseFloat(aVal), l2 = parseFloat(l2Val), l1 = parseFloat(l1Val);
        const resArea = document.getElementById('resultArea');
        if (isNaN(l1) || isNaN(l2) || isNaN(a) || a <= 0) { resArea.classList.add('hidden'); currentResult = null; return; }
        let z, y;
        if (calcDirection === 'LtoR') { y = l1 % a; z = (a - ((l1 + l2) % a)) % a; } else { z = l1 % a; y = (a - ((l1 + l2) % a)) % a; }
        const fZ = Math.round(z * 10) / 10, fY = Math.round(y * 10) / 10;
        currentResult = { mode: '横', no: noVal || '-', inputs: { a, l2, l1 }, outputs: { z: fZ, y: fY }, calcDir: calcDirection };
        
        document.getElementById('numericResults').className = "grid grid-cols-2 gap-3";
        document.getElementById('numericResults').innerHTML = `
            <div class="bg-[#1c1c1e] rounded-2xl py-2 px-4 border border-[#2c2c2e] text-center shadow-lg"><p class="text-[13px] font-bold text-[#d1d1d6] mb-1">左側切込</p><p class="text-[38px] font-bold text-[#0a84ff] leading-none">${formatNumber(fZ)}<span class="text-sm ml-1 text-[#d1d1d6]">mm</span></p></div>
            <div class="bg-[#1c1c1e] rounded-2xl py-2 px-4 border border-[#2c2c2e] text-center shadow-lg"><p class="text-[13px] font-bold text-[#d1d1d6] mb-1">右側切込</p><p class="text-[38px] font-bold text-[#30d158] leading-none">${formatNumber(fY)}<span class="text-sm ml-1 text-[#d1d1d6]">mm</span></p></div>`;
        updateSideSVG(l1, l2, a, fZ, fY);
        resArea.classList.remove('hidden');
        window.triggerAutoSave({...currentResult});
    };

    window.calculateHeight = function() {
        const tVal = unformatNumber(document.getElementById('h_total').value), l2Val = unformatNumber(document.getElementById('h_l2').value), l1Val = unformatNumber(document.getElementById('h_l1').value), noVal = document.getElementById('h_no').value;
        const t = parseFloat(tVal), l2 = parseFloat(l2Val), l1 = parseFloat(l1Val);
        const resArea = document.getElementById('resultArea');
        if (isNaN(t) || isNaN(l1) || isNaN(l2) || t <= 0) { resArea.classList.add('hidden'); currentResult = null; return; }
        const rD = l1, rU = l1 + l2, rT = t - rU;
        currentResult = { mode: '縦', no: noVal || '-', inputs: { total: t, l2, l1 }, outputs: { down: rD, up: rU, top: rT } };
        
        document.getElementById('numericResults').className = "grid grid-cols-1 sm:grid-cols-3 gap-3";
        document.getElementById('numericResults').innerHTML = `
            <div class="bg-[#1c1c1e] rounded-2xl py-2 border border-[#2c2c2e] text-center shadow-lg"><p class="text-[13px] font-bold text-[#d1d1d6] mb-1">下 切込</p><p class="text-[38px] font-bold text-white leading-none">${formatNumber(rD)}<span class="text-sm ml-1 text-[#d1d1d6]">mm</span></p></div>
            <div class="bg-[#1c1c1e] rounded-2xl py-2 border border-[#2c2c2e] text-center shadow-lg"><p class="text-[13px] font-bold text-[#d1d1d6] mb-1">上 切込</p><p class="text-[38px] font-bold text-[#5e5ce6] leading-none">${formatNumber(rU)}<span class="text-sm ml-1 text-[#d1d1d6]">mm</span></p></div>
            <div class="bg-[#1c1c1e] rounded-2xl py-2 border border-[#2c2c2e] text-center shadow-lg"><p class="text-[13px] font-bold text-[#d1d1d6] mb-1">上寸法</p><p class="text-[38px] font-bold text-[#30d158] leading-none">${formatNumber(rT)}<span class="text-sm ml-1 text-[#d1d1d6]">mm</span></p></div>`;
        updateHeightSVG(t, l1, l2, rU, rT);
        resArea.classList.remove('hidden');
        window.triggerAutoSave({...currentResult});
    };

    function updateSideSVG(l1, l2, a, zVal, yVal) {
        const scale = 340 / (6 * a), centerWorld = l1 + (l2 / 2), startJointIndex = Math.floor(centerWorld / a) - 3;
        let jointsHtml = "", joints = [];
        for (let i = 0; i < 7; i++) {
            const jWorld = (startJointIndex + i) * a, jX = 200 + (jWorld - centerWorld) * scale;
            joints.push(jX);
            jointsHtml += `<line x1="${jX}" y1="15" x2="${jX}" y2="185" stroke="#666666" stroke-width="1.2" stroke-dasharray="5,4" />`;
        }
        const winW = l2 * scale, winLE = 200 + (l1 - centerWorld) * scale, winRE = winLE + winW;
        const jZ = [...joints].reverse().find(j => j <= winLE + 1.5), jY = joints.find(j => j >= winRE - 1.5);
        const dirX = calcDirection === 'LtoR' ? 385 : 15, dirAnchor = calcDirection === 'LtoR' ? 'end' : 'start';
        document.getElementById('svgContainer').innerHTML = `<svg viewBox="0 0 400 200" class="w-full h-full"><rect x="5" y="5" width="390" height="190" fill="none" stroke="#d1d1d6" stroke-width="1" />${jointsHtml}<rect x="${winLE}" y="50" width="${winW}" height="80" fill="#3a3a3c" stroke="#ffffff" stroke-width="3" /><text x="${winLE + winW/2}" y="95" text-anchor="middle" font-size="13" fill="#ffffff" font-weight="black">開口部</text><line x1="${winLE}" y1="155" x2="${jZ ? jZ : 0}" y2="155" stroke="#0a84ff" stroke-width="3" /><text x="${(winLE + (jZ ? jZ : 0))/2}" y="185" text-anchor="middle" font-size="${zVal > 999 ? 22 : 28}" fill="#0a84ff" font-weight="black">${formatNumber(zVal)}</text><line x1="${winRE}" y1="155" x2="${jY ? jY : 400}" y2="155" stroke="#30d158" stroke-width="3" /><text x="${(winRE + (jY ? jY : 400))/2}" y="185" text-anchor="middle" font-size="${yVal > 999 ? 22 : 28}" fill="#30d158" font-weight="black">${formatNumber(yVal)}</text><text x="${dirX}" y="30" text-anchor="${dirAnchor}" font-size="11" fill="#ff9f0a" font-weight="bold">${calcDirection === 'LtoR' ? '← 張出方向' : '張出方向 →'}</text><text x="${dirX}" y="95" text-anchor="${dirAnchor}" font-size="16" fill="#ffffff" font-weight="black">W:${formatNumber(l1)}</text></svg>`;
    }

    function updateHeightSVG(total, l1, l2, rUp, rTop) {
        const hS = 160 / total, wB = 185, wT = 25, winYB = wB - (l1 * hS), winH = l2 * hS, winYT = winYB - winH;
        document.getElementById('svgContainer').innerHTML = `<svg viewBox="0 0 400 210" class="w-full h-full"><rect x="150" y="${wT}" width="100" height="${wB - wT}" fill="none" stroke="#d1d1d6" stroke-width="2" /><rect x="160" y="${winYT}" width="80" height="${winH}" fill="#3a3a3c" stroke="#ffffff" stroke-width="3" /><text x="200" y="${winYT + winH/2 + 5}" text-anchor="middle" font-size="13" fill="#ffffff" font-weight="black">開口部</text><text x="200" y="${winYB + 25}" text-anchor="middle" font-size="16" fill="#ffffff" font-weight="black">H:${formatNumber(l1)}</text><line x1="130" y1="${wB}" x2="130" y2="${winYB}" stroke="#ffffff" stroke-width="3" /><text x="120" y="${(wB + winYB)/2 + 8}" text-anchor="end" font-size="28" fill="#ffffff" font-weight="black">${formatNumber(l1)}</text><line x1="270" y1="${wB}" x2="270" y2="${winYT}" stroke="#5e5ce6" stroke-width="3" /><text x="280" y="${(wB + winYT)/2 + 8}" text-anchor="start" font-size="28" fill="#5e5ce6" font-weight="black">${formatNumber(rUp)}</text><line x1="130" y1="${winYT}" x2="130" y2="${wT}" stroke="#30d158" stroke-width="3" /><text x="120" y="${(winYT + wT)/2 + 8}" text-anchor="end" font-size="28" fill="#30d158" font-weight="black">${formatNumber(rTop)}</text><text x="150" y="${wB + 15}" font-size="10" fill="#d1d1d6" font-weight="bold">下端 0</text></svg>`;
    }

    window.renderHistory = function() {
        const sideList = document.getElementById('sideHistoryList'), heightList = document.getElementById('heightHistoryList');
        const render = item => {
            const isChecked = item.checked, themeColor = item.mode === '横' ? '#ff9f0a' : '#e67600';
            const res = item.mode === '横' ? 
                `<div class="flex justify-around pt-3 border-t border-[#2c2c2e]"><div class="text-center"><p class="text-[10px] font-bold text-[#d1d1d6]">左側切込</p><p class="text-[24px] font-bold text-[#0a84ff] leading-none">${formatNumber(item.outputs.z)}</p></div><div class="text-center"><p class="text-[10px] font-bold text-[#d1d1d6]">右側切込</p><p class="text-[24px] font-bold text-[#30d158] leading-none">${formatNumber(item.outputs.y)}</p></div></div>` : 
                `<div class="grid grid-cols-3 pt-3 border-t border-[#2c2c2e]"><div class="text-center"><p class="text-[10px] font-bold text-[#d1d1d6]">下切</p><p class="text-[20px] font-bold text-white">${formatNumber(item.outputs.down)}</p></div><div class="text-center"><p class="text-[10px] font-bold text-[#d1d1d6]">上切</p><p class="text-[20px] font-bold text-[#5e5ce6]">${formatNumber(item.outputs.up)}</p></div><div class="text-center"><p class="text-[10px] font-bold text-[#d1d1d6]">上寸</p><p class="text-[20px] font-bold text-[#30d158]">${formatNumber(item.outputs.top)}</p></div></div>`;
            if (isChecked) {
                return `<div class="history-item py-2 px-4 rounded-2xl border border-[#2c2c2e] checked shadow-lg mb-2" style="border-color: ${themeColor}" onclick="applyHistoryItem('${item.id}')"><div class="flex justify-between items-center mb-1"><div class="flex items-center gap-2"><button type="button" onclick="event.stopPropagation(); toggleCheck('${item.id}', true)" style="color: ${themeColor}"><svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></button><span class="bg-white text-black text-[11px] font-black px-2 py-0.5 rounded-full shadow-md transition-all">No.${item.no}</span><span class="text-[15px] font-bold text-white ml-1">${item.mode==='横'?'寸法':'下寸'}: ${formatNumber(item.inputs.l1)}</span></div><span style="color: ${themeColor}" class="text-[11px] font-bold transition-all">${item.mode}${item.calcDir ? (item.calcDir==='LtoR'?'(左←)':'(左→)') : ''}</span></div>${res}</div>`;
            } else {
                const results = item.mode === '横' ? `<div class="flex gap-x-6"><div class="flex items-baseline"><span class="text-[#d1d1d6] text-[12px] mr-1.5">左</span><span class="text-[19px] font-black text-[#0a84ff]">${formatNumber(item.outputs.z)}</span></div><div class="flex items-baseline"><span class="text-[#d1d1d6] text-[12px] mr-1.5">右</span><span class="text-[19px] font-black text-[#30d158]">${formatNumber(item.outputs.y)}</span></div></div>` : `<div class="flex gap-x-4"><div class="flex items-baseline"><span class="text-[#d1d1d6] text-[12px] mr-1.5">下</span><span class="text-[17px] font-black text-white">${formatNumber(item.outputs.down)}</span></div><div class="flex items-baseline"><span class="text-[#d1d1d6] text-[12px] mr-1.5">上</span><span class="text-[17px] font-black text-[#5e5ce6]">${formatNumber(item.outputs.up)}</span></div><div class="flex items-baseline"><span class="text-[#d1d1d6] text-[12px] mr-1.5">寸</span><span class="text-[17px] font-black text-[#30d158]">${formatNumber(item.outputs.top)}</span></div></div>`;
                return `<div class="history-item px-3 py-3 rounded-xl border border-[#2c2c2e] flex flex-col gap-2 mb-2" onclick="applyHistoryItem('${item.id}')"><div class="flex items-center justify-between"><div class="flex items-center gap-2"><button type="button" onclick="event.stopPropagation(); toggleCheck('${item.id}', false)" class="text-white bg-[#444] rounded-full p-0.5 active:scale-125 transition-transform mr-1"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></button><span class="text-[#d1d1d6] font-bold text-[14px] transition-all">No.${item.no}</span><span class="text-white font-bold text-[15px] ml-1">${item.mode==='横'?'寸法':'下寸'}: ${formatNumber(item.inputs.l1)}</span></div><span class="text-[#d1d1d6] font-bold text-[11px] uppercase transition-all">${item.mode}切込</span></div><div class="flex justify-center bg-[#000] py-2 rounded-lg border border-[#2c2c2e] shadow-inner">${results}</div></div>`;
            }
        };
        sideList.innerHTML = window.historyData.filter(d => d.mode === '横').map(render).join('') || '<p class="text-center text-[#d1d1d6] opacity-20 py-4 text-xs italic">データなし</p>';
        heightList.innerHTML = window.historyData.filter(d => d.mode === '縦').map(render).join('') || '<p class="text-center text-[#d1d1d6] opacity-20 py-4 text-xs italic">データなし</p>';
    };
</script>

</body>
</html>