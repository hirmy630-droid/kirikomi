<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>切込寸法 計算アプリ - Dark Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, getDocs, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state
        window.historyData = [];
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cutting-calc-app';
        let lastSavedHash = ""; 

        // Initialize Firebase
        const initFirebase = async () => {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // RULE 3: Auth Before Queries
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };

            await initAuth();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    loadHistory(); // ユーザー確定後に履歴読み込みを開始
                }
            });
        };

        const loadHistory = () => {
            if (!userId) return;
            // RULE 1: Strict Paths
            const historyCol = collection(db, 'artifacts', appId, 'users', userId, 'history');
            
            // iPhone/Safariの不具合対策としてリスナーを確実にセット
            onSnapshot(historyCol, async (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.historyData = data.sort((a, b) => b.createdAt - a.createdAt);
                
                // 自動削除ロジック: チェックなし項目を3件までに制限
                const uncheckedItems = window.historyData.filter(item => !item.checked);
                if (uncheckedItems.length > 3) {
                    const toDelete = uncheckedItems.slice(3); 
                    const batch = writeBatch(db);
                    toDelete.forEach(item => {
                        batch.delete(doc(db, 'artifacts', appId, 'users', userId, 'history', item.id));
                    });
                    await batch.commit();
                }

                window.renderHistory();
            }, (error) => {
                console.error("Firestore Loading Error:", error);
            });
        };

        window.saveToCloud = async (item) => {
            if (!userId || !item) return;
            const hash = JSON.stringify(item.inputs) + item.mode + item.no + (item.calcDir || '');
            if (hash === lastSavedHash) return;
            lastSavedHash = hash;

            const historyCol = collection(db, 'artifacts', appId, 'users', userId, 'history');
            await addDoc(historyCol, {
                ...item,
                checked: false, 
                createdAt: Date.now()
            });
        };

        window.toggleCheck = async (id, currentStatus) => {
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'history', id);
            await updateDoc(docRef, {
                checked: !currentStatus
            });
        };

        window.executeConfirm = async () => {
            if (!window.pendingAction || !userId) return;
            const { action, mode } = window.pendingAction;
            let itemsToDelete = window.historyData.filter(d => !d.checked && (action === 'all' || d.mode === mode));
            if (itemsToDelete.length > 0) {
                const batch = writeBatch(db);
                itemsToDelete.forEach(d => batch.delete(doc(db, 'artifacts', appId, 'users', userId, 'history', d.id)));
                await batch.commit();
            }
            document.getElementById('customConfirmModal').classList.add('hidden');
        };

        window.onload = initFirebase;
    </script>

    <style>
        body { background-color: #000000; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; overflow-x: hidden; touch-action: pan-y; }
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        .input-card { background: #1c1c1e; border-radius: 14px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        
        /* 3Dタブボタン */
        .tab-bar { background-color: #111; padding: 4px; border-radius: 12px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.5); }
        .tab-button { 
            padding-top: 0.6rem; 
            padding-bottom: 0.6rem; 
            font-size: 16px !important; 
            color: #8e8e93; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            background: linear-gradient(180deg, #2c2c2e 0%, #1c1c1e 100%);
            border: 1px solid #3a3a3c;
            box-shadow: 0 1px 0 rgba(255,255,255,0.05);
            margin: 0 2px;
        }
        .tab-active { 
            background: linear-gradient(180deg, #48484a 0%, #2c2c2e 100%) !important; 
            color: #ff9f0a !important; 
            border-color: #ff9f0a;
            box-shadow: 0 4px 10px rgba(255, 159, 10, 0.2), inset 0 1px 0 rgba(255,255,255,0.1) !important;
            font-weight: 900;
            transform: translateY(-1px);
        }

        input { background-color: #2c2c2e !important; color: #ffffff !important; border: 1px solid #3a3a3c !important; }
        .input-highlight-border { border: 2px solid #ff9f0a !important; }
        input::placeholder { font-size: 16px; color: #636366; }

        .btn-gray-3d { background: linear-gradient(180deg, #aeaeb2 0%, #8e8e93 100%); color: #ffffff; border: 1px solid #aeaeb2; box-shadow: 0 3px 0 #3a3a3c; position: relative; top: 0; }
        .btn-silver-3d { background: linear-gradient(180deg, #f2f2f7 0%, #d1d1d6 100%); color: #1c1c1e; border: 1px solid #ffffff; box-shadow: 0 3px 0 #48484a; position: relative; top: 0; }

        .history-item { animation: slideIn 0.3s ease-out; background: #1c1c1e; border: 1px solid #2c2c2e; }
        .history-item.checked { border-color: #ff9f0a; }
        .text-silver { color: #d1d1d6 !important; }

        .dir-switch-bar { background-color: #1c1c1e; padding: 2px; border-radius: 8px; }
        .dir-button { font-size: 13px !important; color: #aeaeb2; padding: 6px 12px; }
        .dir-active { background-color: #3a3a3c !important; color: #ffffff !important; border-radius: 6px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-white">

<div class="app-container p-4" id="mainApp">
    <header class="text-center py-4">
        <h1 class="text-[32px] font-bold text-white tracking-tight">切込寸法 計算</h1>
        <p class="text-[15px] font-medium text-silver mt-0 uppercase tracking-widest">KYOWA ROOF</p>
    </header>

    <div class="flex mb-6 tab-bar">
        <button onclick="switchTab('side')" id="tabSide" class="tab-button flex-1 font-bold rounded-[8px] tab-active">横 切込</button>
        <button onclick="switchTab('height')" id="tabHeight" class="tab-button flex-1 font-bold rounded-[8px]">縦 切込</button>
    </div>

    <div id="swipeTarget">
        <div id="sideContent">
            <div class="input-card p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-[14px] font-semibold text-silver mb-1 ml-1">働き幅</label>
                        <input type="text" inputmode="numeric" id="side_a" placeholder="働き幅" oninput="formatInput(this); calculateSide();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                    <div>
                        <label class="block text-[14px] font-semibold text-silver mb-1 ml-1">対象横幅</label>
                        <input type="text" inputmode="numeric" id="side_l2" placeholder="対象横幅" oninput="formatInput(this); calculateSide();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-[14px] font-semibold text-silver mb-1 ml-1">寸法(張方向↔︎対象)</label>
                        <input type="text" inputmode="numeric" id="side_l1" placeholder="寸法を入力" oninput="formatInput(this); calculateSide();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-3 py-3 text-[28px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                    <div class="w-24">
                        <label class="block text-[14px] font-semibold text-silver mb-1 text-center">No.</label>
                        <input type="text" inputmode="numeric" id="side_no" maxlength="2" placeholder="No" oninput="calculateSide();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-2 py-3 text-[27px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                </div>
            </div>
        </div>

        <div id="heightContent" class="hidden">
            <div class="input-card p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-[14px] font-semibold text-silver mb-1 ml-1">全長</label>
                        <input type="text" inputmode="numeric" id="h_total" placeholder="全長" oninput="formatInput(this); calculateHeight();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                    <div>
                        <label class="block text-[14px] font-semibold text-silver mb-1 ml-1">対象縦幅</label>
                        <input type="text" inputmode="numeric" id="h_l2" placeholder="対象縦幅" oninput="formatInput(this); calculateHeight();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-3 py-2 text-[27px] font-bold text-center outline-none shadow-inner">
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-[14px] font-semibold text-silver mb-1 ml-1">寸法(下↑対象)</label>
                        <input type="text" inputmode="numeric" id="h_l1" placeholder="寸法を入力" oninput="formatInput(this); calculateHeight();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-3 py-3 text-[28px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                    <div class="w-24">
                        <label class="block text-[14px] font-semibold text-silver mb-1 text-center">No.</label>
                        <input type="text" inputmode="numeric" id="h_no" maxlength="2" placeholder="No" oninput="calculateHeight();" onblur="saveImmediately()" onfocus="this.select()" class="w-full rounded-xl px-2 py-3 text-[27px] font-bold text-center outline-none shadow-inner input-highlight-border">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resultArea" class="hidden space-y-3 mb-10">
        <div id="directionToggle" class="flex justify-center mb-1">
            <div class="dir-switch-bar flex gap-1">
                <!-- タブのテキストを入れ替え -->
                <button onclick="setCalcDir('LtoR')" id="btnLtoR" class="dir-button font-bold dir-active">左←右</button>
                <button onclick="setCalcDir('RtoL')" id="btnRtoL" class="dir-button font-bold">左→右</button>
            </div>
        </div>
        <div class="bg-[#111] rounded-2xl border border-[#333] shadow-xl overflow-hidden p-1">
            <div id="svgContainer" class="w-full bg-[#000] rounded-xl overflow-hidden"></div>
        </div>
        <div id="numericResults" class="grid gap-3"></div>
    </div>

    <div id="historyArea" class="mt-4 border-t border-[#2c2c2e] pt-6 pb-24">
        <div class="flex items-center justify-between mb-8 px-1">
            <h2 class="text-[22px] font-bold text-white tracking-tight">計算履歴</h2>
            <button onclick="openConfirm('all')" class="btn-gray-3d text-[11px] font-black px-4 py-1.5 rounded-full uppercase shadow-sm">一括削除</button>
        </div>
        <div class="mb-12">
            <div class="flex justify-between items-center mb-5 px-1">
                <h3 class="text-silver text-[18px] font-bold uppercase tracking-widest">横切込の履歴</h3>
                <button onclick="openConfirm('category', '横')" class="btn-silver-3d text-[10px] font-black px-4 py-1.5 rounded-full shadow-sm">削除</button>
            </div>
            <div id="sideHistoryList" class="space-y-3"></div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-5 px-1">
                <h3 class="text-silver text-[18px] font-bold uppercase tracking-widest">縦切込の履歴</h3>
                <button onclick="openConfirm('category', '縦')" class="btn-silver-3d text-[10px] font-black px-4 py-1.5 rounded-full shadow-sm">削除</button>
            </div>
            <div id="heightHistoryList" class="space-y-3"></div>
        </div>
    </div>

    <div id="customConfirmModal" class="hidden fixed inset-0 flex items-center justify-center p-6 shadow-2xl" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 9999;">
        <div class="bg-[#1c1c1e] w-full max-w-sm rounded-3xl p-6 border border-[#3a3a3c] text-center">
            <h4 class="text-[18px] font-bold text-white mb-3">確認</h4>
            <p id="confirmMessage" class="text-silver text-[14px] mb-6 leading-relaxed"></p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('customConfirmModal').classList.add('hidden')" class="flex-1 bg-[#2c2c2e] text-white font-bold py-3 rounded-xl active:opacity-70">キャンセル</button>
                <button onclick="executeConfirm()" class="flex-1 bg-[#ff453a] text-white font-bold py-3 rounded-xl active:opacity-70">削除する</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentMode = 'side', currentResult = null, calcDirection = 'LtoR';

    function switchTab(mode) {
        currentMode = mode;
        document.getElementById('sideContent').classList.toggle('hidden', mode !== 'side');
        document.getElementById('heightContent').classList.toggle('hidden', mode !== 'height');
        document.getElementById('tabSide').classList.toggle('tab-active', mode === 'side');
        document.getElementById('tabHeight').classList.toggle('tab-active', mode === 'height');
        if (mode === 'side') calculateSide(); else calculateHeight();
        document.getElementById('directionToggle').classList.toggle('hidden', mode !== 'side');
    }

    function setCalcDir(dir) {
        calcDirection = dir;
        document.getElementById('btnLtoR').classList.toggle('dir-active', dir === 'LtoR');
        document.getElementById('btnRtoL').classList.toggle('dir-active', dir === 'RtoL');
        if (currentMode === 'side') calculateSide();
    }

    function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function unformatNumber(str) { return str ? str.replace(/,/g, '') : ''; }

    window.formatInput = function(el) {
        let val = unformatNumber(el.value);
        if (isNaN(val) && val !== "") { el.value = el.dataset.oldValue || ""; return; }
        el.value = (val === "") ? "" : formatNumber(val);
        el.dataset.oldValue = el.value;
    };

    window.saveImmediately = function() { if (currentResult) window.saveToCloud({...currentResult}); };

    window.calculateSide = function() {
        const aVal = unformatNumber(document.getElementById('side_a').value);
        const l2Val = unformatNumber(document.getElementById('side_l2').value);
        const l1Val = unformatNumber(document.getElementById('side_l1').value);
        const noVal = document.getElementById('side_no').value;
        const a = parseFloat(aVal), l2 = parseFloat(l2Val), l1 = parseFloat(l1Val);
        const resultArea = document.getElementById('resultArea');
        if (isNaN(l1) || isNaN(l2) || isNaN(a) || a <= 0) { resultArea.classList.add('hidden'); currentResult = null; return; }

        let z, y;
        if (calcDirection === 'LtoR') {
            y = l1 % a;
            z = (a - ((l1 + l2) % a)) % a;
        } else {
            z = l1 % a;
            y = (a - ((l1 + l2) % a)) % a;
        }

        const round = n => Math.round(n * 10) / 10;
        const fZ = round(z), fY = round(y);
        currentResult = { mode: '横', no: noVal || '-', inputs: { a, l2, l1 }, outputs: { z: fZ, y: fY }, calcDir: calcDirection };

        document.getElementById('numericResults').className = "grid grid-cols-2 gap-3";
        document.getElementById('numericResults').innerHTML = `
            <div class="bg-[#1c1c1e] rounded-2xl py-3 px-4 border border-[#2c2c2e] text-center shadow-lg">
                <p class="text-[13px] font-bold text-[#d1d1d6] mb-1">左側切込</p>
                <p class="text-[40px] font-bold text-[#0a84ff] leading-none">${formatNumber(fZ)}<span class="text-sm ml-1 text-silver">mm</span></p>
            </div>
            <div class="bg-[#1c1c1e] rounded-2xl py-3 px-4 border border-[#2c2c2e] text-center shadow-lg">
                <p class="text-[13px] font-bold text-[#d1d1d6] mb-1">右側切込</p>
                <p class="text-[40px] font-bold text-[#30d158] leading-none">${formatNumber(fY)}<span class="text-sm ml-1 text-silver">mm</span></p>
            </div>
        `;
        updateSideSVG(l1, l2, a, fZ, fY);
        resultArea.classList.remove('hidden');
    };

    window.calculateHeight = function() {
        const tVal = unformatNumber(document.getElementById('h_total').value), l2Val = unformatNumber(document.getElementById('h_l2').value), l1Val = unformatNumber(document.getElementById('h_l1').value), noVal = document.getElementById('h_no').value;
        const t = parseFloat(tVal), l2 = parseFloat(l2Val), l1 = parseFloat(l1Val);
        const resultArea = document.getElementById('resultArea');
        if (isNaN(t) || isNaN(l1) || isNaN(l2) || t <= 0) { resultArea.classList.add('hidden'); currentResult = null; return; }
        const rDown = l1, rUp = l1 + l2, rTop = t - rUp;
        currentResult = { mode: '縦', no: noVal || '-', inputs: { total: t, l2, l1 }, outputs: { down: rDown, up: rUp, top: rTop } };
        document.getElementById('numericResults').className = "grid grid-cols-1 sm:grid-cols-3 gap-3";
        document.getElementById('numericResults').innerHTML = `
            <div class="bg-[#1c1c1e] rounded-2xl py-3 border border-[#2c2c2e] text-center shadow-lg">
                <p class="text-[13px] font-bold text-[#d1d1d6] mb-1">下 切込</p>
                <p class="text-[40px] font-bold text-white leading-none">${formatNumber(rDown)}<span class="text-sm ml-1 text-silver">mm</span></p>
            </div>
            <div class="bg-[#1c1c1e] rounded-2xl py-3 border border-[#2c2c2e] text-center shadow-lg">
                <p class="text-[13px] font-bold text-[#d1d1d6] mb-1">上 切込</p>
                <p class="text-[40px] font-bold text-[#5e5ce6] leading-none">${formatNumber(rUp)}<span class="text-sm ml-1 text-silver">mm</span></p>
            </div>
            <div class="bg-[#1c1c1e] rounded-2xl py-3 border border-[#2c2c2e] text-center shadow-lg">
                <p class="text-[13px] font-bold text-[#d1d1d6] mb-1">上寸法</p>
                <p class="text-[40px] font-bold text-[#30d158] leading-none">${formatNumber(rTop)}<span class="text-sm ml-1 text-silver">mm</span></p>
            </div>
        `;
        updateHeightSVG(t, l1, l2, rUp, rTop);
        resultArea.classList.remove('hidden');
    };

    function updateSideSVG(l1, l2, a, zVal, yVal) {
        const scale = 340 / (6 * a); 
        const joints = [];
        const centerWorld = l1 + (l2 / 2);
        const startJointIndex = Math.floor(centerWorld / a) - 3;
        let jointsHtml = "";
        
        for (let i = 0; i < 7; i++) {
            const jWorld = (startJointIndex + i) * a;
            const jX = 200 + (jWorld - centerWorld) * scale;
            joints.push(jX);
            jointsHtml += `<line x1="${jX}" y1="15" x2="${jX}" y2="185" stroke="#d1d1d6" stroke-width="1.2" stroke-dasharray="5,4" />`;
        }
        
        const winW = l2 * scale;
        const winLE = 200 + (l1 - centerWorld) * scale;
        const winRE = winLE + winW;
        const jZ = [...joints].reverse().find(j => j <= winLE + 1.5);
        const jY = joints.find(j => j >= winRE - 1.5);

        document.getElementById('svgContainer').innerHTML = `
            <svg viewBox="0 0 400 200" class="w-full h-full">
                <rect x="5" y="5" width="390" height="190" fill="none" stroke="#d1d1d6" stroke-width="1" />
                ${jointsHtml}
                <rect x="${winLE}" y="50" width="${winW}" height="80" fill="#3a3a3c" stroke="#ffffff" stroke-width="3" />
                <text x="${winLE + winW/2}" y="95" text-anchor="middle" font-size="13" fill="#ffffff" font-weight="black">開口部</text>
                <line x1="${winLE}" y1="155" x2="${jZ ? jZ : 0}" y2="155" stroke="#0a84ff" stroke-width="3" />
                <text x="${(winLE + (jZ ? jZ : 0))/2}" y="185" text-anchor="middle" font-size="${zVal > 999 ? 22 : 28}" fill="#0a84ff" font-weight="black">${formatNumber(zVal)}</text>
                <line x1="${winRE}" y1="155" x2="${jY ? jY : 400}" y2="155" stroke="#30d158" stroke-width="3" />
                <text x="${(winRE + (jY ? jY : 400))/2}" y="185" text-anchor="middle" font-size="${yVal > 999 ? 22 : 28}" fill="#30d158" font-weight="black">${formatNumber(yVal)}</text>
                <text x="${calcDirection === 'LtoR' ? 15 : 385}" y="30" text-anchor="${calcDirection === 'LtoR' ? 'start' : 'end'}" font-size="11" fill="#ff9f0a" font-weight="bold">${calcDirection === 'LtoR' ? '張出方向 →' : '← 張出方向'}</text>
            </svg>`;
    }

    function updateHeightSVG(total, l1, l2, rUp, rTop) {
        const hS = 160 / total, wB = 185, wT = 25, winYB = wB - (l1 * hS), winH = l2 * hS, winYT = winYB - winH;
        document.getElementById('svgContainer').innerHTML = `
            <svg viewBox="0 0 400 210" class="w-full h-full">
                <rect x="150" y="${wT}" width="100" height="${wB - wT}" fill="none" stroke="#d1d1d6" stroke-width="2" />
                <rect x="160" y="${winYT}" width="80" height="${winH}" fill="#3a3a3c" stroke="#ffffff" stroke-width="3" />
                <text x="200" y="${winYT + winH/2 + 5}" text-anchor="middle" font-size="11" fill="#ffffff" font-weight="black">開口部</text>
                <line x1="130" y1="${wB}" x2="130" y2="${winYB}" stroke="#ffffff" stroke-width="3" />
                <text x="120" y="${(wB + winYB)/2 + 8}" text-anchor="end" font-size="28" fill="#ffffff" font-weight="black">${formatNumber(l1)}</text>
                <line x1="270" y1="${wB}" x2="270" y2="${winYT}" stroke="#5e5ce6" stroke-width="3" />
                <text x="280" y="${(wB + winYT)/2 + 8}" text-anchor="start" font-size="28" fill="#5e5ce6" font-weight="black">${formatNumber(rUp)}</text>
                <line x1="130" y1="${winYT}" x2="130" y2="${wT}" stroke="#30d158" stroke-width="3" />
                <text x="120" y="${(winYT + wT)/2 + 8}" text-anchor="end" font-size="28" fill="#30d158" font-weight="black">${formatNumber(rTop)}</text>
                <text x="150" y="${wB + 15}" font-size="10" fill="#d1d1d6" font-weight="bold">下端 0</text>
            </svg>`;
    }

    window.renderHistory = function() {
        const sideList = document.getElementById('sideHistoryList'), heightList = document.getElementById('heightHistoryList');
        const render = item => {
            const isChecked = item.checked, color = isChecked ? 'text-[#ff9f0a]' : 'text-white', bg = isChecked ? 'bg-transparent' : 'bg-[#8e8e93]';
            if (isChecked) {
                const res = item.mode === '横' ? `<div class="flex justify-around pt-3 border-t border-[#2c2c2e]"><div class="text-center"><p class="text-[12px] font-bold text-silver">左側切込</p><p class="text-[28px] font-bold text-[#0a84ff] leading-none">${formatNumber(item.outputs.z)}</p></div><div class="text-center"><p class="text-[12px] font-bold text-silver">右側切込</p><p class="text-[28px] font-bold text-[#30d158] leading-none">${formatNumber(item.outputs.y)}</p></div></div>` : `<div class="grid grid-cols-3 pt-3 border-t border-[#2c2c2e]"><div class="text-center"><p class="text-[11px] font-bold text-silver">下切</p><p class="text-[24px] font-bold text-white">${formatNumber(item.outputs.down)}</p></div><div class="text-center"><p class="text-[11px] font-bold text-silver">上切</p><p class="text-[24px] font-bold text-[#5e5ce6]">${formatNumber(item.outputs.up)}</p></div><div class="text-center"><p class="text-[11px] font-bold text-silver">上寸</p><p class="text-[24px] font-bold text-[#30d158]">${formatNumber(item.outputs.top)}</p></div></div>`;
                return `<div class="history-item py-2.5 px-4 rounded-2xl border border-[#2c2c2e] checked shadow-lg"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-3"><button onclick="toggleCheck('${item.id}', true)" class="${color}"><svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></button><span class="bg-white text-black text-[13px] font-black px-3 py-1 rounded-full shadow-md">No. ${item.no}</span><span class="text-[16px] font-bold text-white">${item.mode==='横'?'寸法':'下寸'}: ${formatNumber(item.inputs.l1)}</span></div><span class="bg-[#ff9f0a] text-black text-[15px] font-black px-3 py-1 rounded">${item.mode}${item.calcDir==='RtoL'?'(左←)':'(左→)'}</span></div>${res}</div>`;
            } else {
                const results = item.mode === '横' ? `<div class="flex gap-x-4"><div class="flex items-baseline"><span class="text-silver text-[15px] mr-1.5">左</span><span class="text-[16px] font-black text-[#0a84ff] tracking-tight">${formatNumber(item.outputs.z)}</span></div><div class="flex items-baseline"><span class="text-silver text-[15px] mr-1.5">右</span><span class="text-[16px] font-black text-[#30d158] tracking-tight">${formatNumber(item.outputs.y)}</span></div></div>` : `<div class="flex gap-x-4"><div class="flex items-baseline"><span class="text-silver text-[15px] mr-1.5">下</span><span class="text-[16px] font-black text-white tracking-tight">${formatNumber(item.outputs.down)}</span></div><div class="flex items-baseline"><span class="text-silver text-[15px] mr-1.5">上</span><span class="text-[16px] font-black text-[#5e5ce6] tracking-tight">${formatNumber(item.outputs.up)}</span></div><div class="flex items-baseline"><span class="text-silver text-[15px] mr-1.5">寸</span><span class="text-[16px] font-black text-[#30d158] tracking-tight">${formatNumber(item.outputs.top)}</span></div></div>`;
                return `<div class="history-item px-3 py-3 rounded-xl border border-[#2c2c2e] flex items-center justify-between"><div class="flex items-center"><button onclick="toggleCheck('${item.id}', false)" class="${color} ${bg} rounded-full p-0.5 active:scale-125 transition-transform shadow-inner mr-2"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></button><span class="text-silver font-bold text-[14px] min-w-[32px]">No.${item.no}</span>${item.mode==='横'?`<div class="flex items-baseline ml-3"><span class="text-silver text-[15px] mr-1.5">寸法</span><span class="text-white font-bold text-[15px]">${formatNumber(item.inputs.l1)}</span></div>`:''}</div><div class="flex-1 flex justify-center">${results}</div><span class="text-silver font-bold text-[11px] min-w-[38px] text-right uppercase tracking-tighter">${item.mode}切込</span></div>`;
            }
        };
        sideList.innerHTML = window.historyData.filter(d => d.mode === '横').map(render).join('') || '<p class="text-center text-silver opacity-20 py-4 text-xs italic">データなし</p>';
        heightList.innerHTML = window.historyData.filter(d => d.mode === '縦').map(render).join('') || '<p class="text-center text-silver opacity-20 py-4 text-xs italic">データなし</p>';
    };
</script>

</body>
</html>